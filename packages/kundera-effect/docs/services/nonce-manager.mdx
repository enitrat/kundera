---
title: Nonce Manager Service
description: Track and reserve nonces for concurrent transactions.
---

# Nonce Manager Service

`NonceManagerService` tracks a local nonce delta per address, allowing concurrent transaction preparation without nonce collisions. It fetches the on-chain nonce and increments a local counter for each reserved nonce.

## Imports

```typescript
import { Services } from "@kundera-sn/kundera-effect";
// or
import {
  NonceManagerService,
  DefaultNonceManagerLive,
} from "@kundera-sn/kundera-effect/services";
```

## Service Shape

```typescript
interface NonceManagerServiceShape {
  readonly get: (
    address: string,
    options?: NonceRequestOptions,
  ) => Effect.Effect<bigint, NonceError>;

  readonly consume: (
    address: string,
    options?: NonceRequestOptions,
  ) => Effect.Effect<bigint, NonceError>;

  readonly reset: (
    address: string,
  ) => Effect.Effect<void>;
}
```

## Live Layer

`DefaultNonceManagerLive` requires `ProviderService`:

```typescript
import { Layer } from "effect";
import { Services, Presets } from "@kundera-sn/kundera-effect";

const stack = Layer.mergeAll(
  Presets.SepoliaProvider(),
  Services.DefaultNonceManagerLive,
);
```

## Why NonceManager?

When sending multiple transactions quickly, you can't wait for each to confirm before getting the next nonce:

```typescript
const program = Effect.gen(function* () {
  const nonceManager = yield* Services.NonceManagerService;

  // Reserve nonces for 3 concurrent transactions
  const nonce1 = yield* nonceManager.consume("0x1234..."); // e.g., 5n
  const nonce2 = yield* nonceManager.consume("0x1234..."); // e.g., 6n
  const nonce3 = yield* nonceManager.consume("0x1234..."); // e.g., 7n

  // Send transactions with these nonces...

  // After all confirmed, reset to resync with chain
  yield* nonceManager.reset("0x1234...");
});
```

## Methods

### get

Returns the current nonce (on-chain pending + local delta) without consuming it:

```typescript
const nonce = yield* nonceManager.get("0x1234...");
```

### consume

Gets and atomically increments the nonce. Safe for concurrent calls:

```typescript
const nonce = yield* nonceManager.consume("0x1234...");
```

### reset

Clears the local delta for an address. Call after transactions confirm to resync:

```typescript
yield* nonceManager.reset("0x1234...");
```

## Errors

```typescript
class NonceError extends Data.TaggedError("NonceError")<{
  readonly address: string;
  readonly message: string;
  readonly cause?: unknown;
}>
```

## Related

<CardGroup cols={2}>
  <Card title="Account" icon="user" href="/effect/services/account">
    AccountService uses NonceManagerService internally.
  </Card>
  <Card title="Transaction" icon="arrow-right-arrow-left" href="/effect/services/transaction">
    Transaction submission and receipt polling.
  </Card>
</CardGroup>
